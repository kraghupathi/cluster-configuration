#+TITLE:  Ansible
#+PROPERTY: session *scratch*
#+PROPERTY: results output
#+PROPERTY: exports code
#+SETUPFILE: org-templates/level-0.org
#+options: ^:nil

* Introduction

This document describes the requirements, design and implementation of
the ansible server which is part of the cluster.

This server is used to configure all other servers in the cluster.
Using Ansible, a machine is configured using multiple roles.  A role
is a specific set of configurations.

* Requirements

The functional and security requirements for Ansible server are:

** Functional Requirements

  1. Ansible server should manage itself
     + At regular intervals, it should apply firewall rules.
     + At regular intervals, it should update the packages of the OS and other
       software.

  2. Only one user called `ansible` is created on the Ansible server. This
     user has sudo permissions.

  3. Authorized VLEAD users log-in as ansible user.
     Copy the VLEAD authorized_keys file to the Ansible server, under the ansible user.

** Security Requirements
   1. Apply Firewall Rules.
   2. SSH/Port 22 accessible *ONLY* from VLEAD IP range.
   3. Allow ICMP (Ping)
   4. Limit rate of new connections on port 22.
   5. Disable root login via ssh.

* Design

Ansible server
[[https://docs.google.com/a/vlabs.ac.in/drawings/d/1KRicWtnWvtqb06uNl5hYipeAH5KDQywWy7aOVStVAmo/edit?usp=sharing][Edit Image]]

#+CAPTION:  Ansible Design Diagram
#+LABEL:  fig-ansible-diagram
#+NAME: fig-ansible-diagram

[[./diagrams/ansible.png]]


The design of the firewall rules will ensure that this server is
accessible only via port 22. All other ports are disabled. The port 22
is accessible only from VLEAD IP range.  Only key-based login to this
server is allowed. This server can be pinged from anywhere.

* Implementation
** Structure of the scripts
The implementation of this system is in terms of a collection of Ansible scripts that
configure the machine.   These scripts need to be organized in a certain way:

#+BEGIN_EXAMPLE

|-- ansible.yml
|-- roles
|   |-- ansible
|   |   |-- handlers
|   |   |   `-- main.yml
|   |   |-- meta
|   |   |   `-- main.yml
|   |   |-- tasks
|   |   |   |-- main.yml
|   |   `-- templates
|   |       `-- iptables
|   |-- common
|   |   ...
#+END_EXAMPLE

** Hardening, OS Updates etc.
   Requirement 1 {link has to be created} is taken care by the common role.  More
   information is [[./common.org][here]]

** Building the firewall rules

*** The default contents of the firewall
#+BEGIN_SRC YAML :tangle roles/ansible/templates/iptables
*filter
:INPUT ACCEPT [773:1200054]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [940:1161060]
#+END_SRC

*** Loop Back
The ansible server needs to accept all connections from loop back.

#+BEGIN_SRC YAML :tangle roles/ansible/templates/iptables
#Accept all connections from loop-back
-A INPUT -i lo -j ACCEPT
#+END_SRC

*** Ongoing Connections
The server should allow the ongoing connections

#+BEGIN_SRC YAML :tangle roles/ansible/templates/iptables
#Allow ongoing connections
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
#+END_SRC

*** SSH Rule
The server should allow *only* the VLEAD network to ssh to it on port 22.

#+BEGIN_SRC YAML :tangle roles/ansible/templates/iptables
-A INPUT -p tcp -m tcp --dport 22 -s 10.0.0.0/8 -j ACCEPT
#+END_SRC

*** ICMP Rule
The server should accept ping requests(ICMP) from anywhere

#+BEGIN_SRC YAML :tangle roles/ansible/templates/iptables
-A INPUT -p icmp -m icmp --icmp-type echo-request -j ACCEPT
#+END_SRC

*** All other packets should be rejected
The incoming and outgoing packets on all other ports should be rejected.

#+BEGIN_SRC YAML :tangle roles/ansible/templates/iptables :eval no
-A INPUT -j REJECT
-A FORWARD -j REJECT
COMMIT
#+END_SRC

** Copy the firewall rules to the appropriate location
#+BEGIN_SRC YAML :tangle roles/ansible/tasks/main.yml
---
  - name: Copy iptables configuration file for ansible server
    template: src=iptables dest=/etc/sysconfig/iptables mode=600 owner=root group=root
    notify: restart iptables
#+END_SRC

** Applying firewall rules
   Whenever iptables are changed, the iptables service will be restarted.

#+BEGIN_SRC YAML :tangle roles/ansible/handlers/main.yml :eval no
---
  - name: restart iptables
    service: name=iptables state=restarted
#+END_SRC

** Disable root login via ssh
   Common role of ansible ensures that root login is enabled on all machines
   but only via public key authentication. But for the Ansible server we want
   to disable root login altogether via ssh.

   Hence, we modify the =sshd_config= file to disable root login.
   We assume =PermitRootLogin= parameter is already set to some value.

#+BEGIN_SRC YAML :tangle roles/ansible/tasks/main.yml :eval no

  - name: Disable root login via ssh
    lineinfile: dest=/etc/sshd_config regexp="^PermitRootLogin .*" state=present line="PermitRootLogin no"
#+END_SRC

** Dependencies
   All the variables go here. For Ansible server, currently no variables are
   used.
#+BEGIN_SRC YAML :tangle roles/ansible/meta/main.yml
---
dependencies:
- role: common_vars
#+END_SRC

** Putting it together
   The ansible server is managed with all the above rules. The implementation
   is done in terms of defining suitable scripts for each role.  The top level
   script is =build/code/ansible.yml=

#+BEGIN_SRC YAML :tangle ansible.yml
---
- name: Configure ansible server
  hosts: ansible-server
  remote_user: root
  roles:
    - common
    - ansible
#+END_SRC

* Provisioning Of Ansible Machine
This section describes the provisioning of ansible machine on cluster.

** Creation of Ansible machine
   + How ansible machine is created, IP-address of machine, Domain
     name.
*** Ansible machine configuration
   + Operating System: Centos-6.6
   + Memory: 256MB
   + Disk space: 2GB
*** Ansible machine is created using:
   #+BEGIN_SRC shell
   vzctl create 14102 --ostemplate centos-6-x86_64-point6 --hostname ansible.virtual-labs.ac.in --ipadd 10.4.14.102
   #+END_SRC
*** Domain name and IP address of Ansible machine
    - Domain name :: =ansible.virtual-labs.ac.in=
    - IP Address :: =10.4.14.102=
** Access to Ansible machine
   - VLEAD engineers who have their keys placed in =authorized_keys=
     of ansible machine can *only* access.
** Key based authentication is enabled on the Ansible machine.
   LDAP is disabled. Engineers with their public keys added to
   authorized_keys will only be able to ssh.
** List of VLEAD engineers who have access to Ansible machine
   1. Dr.Venkatesh Choppella
   2. Thirumal Ravula
   3. Saurabh Barjatiya
   4. Anon Ray
   5. Zubair
   6. Prakash B Hegde
   7. Jayanth Sagar
   8. Yogesh
   9. Shiva Shankar
  10. Soumya
  11. Ambika
  12. Khushpreet
  13. Sripathi
  14. Madhavi
  15. Sanchita

* Testcases
** SSH should be allowed only from STPI(196.12.53.130).
** Ansible machine must be pingable(ICMP) only from IIIT network.
** All the other ports are blocked.

