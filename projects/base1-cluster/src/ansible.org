#+PROPERTY: session *scratch*
#+PROPERTY: results output
#+PROPERTY: tangle ../build/ansible.yml
#+PROPERTY: exports code
#+SETUPFILE: org-templates/level-0.org

* Introduction

This document describes the requirements, design and implementation of the
ansible server which is part of the cluster.

The Ansible works by configuring servers.   A server may have multiple
roles and a machine is configured for a specific role.    Roles are
build on the idea of include files and combine them to form clean,
reusable abstractions. 

* Requirements
The functional and security requirements for Ansible server are:

** Functional Requirements

   - 1) Ansible server should manage itself :: 

   - 2) Update OS, enforce firewall rules ::  Whenever there is a new update of
        the OS or any package running on the server, that package should be updated on Ansible.

** Security Requirements
   1. Apply Firewall Rules.
   2. SSH/Port 22 accessible *ONLY* from VLEAD IP range.
   3. Allow ICMP (Ping)
   4. Limit rate of new connections on port 22.
   
* Design
#+CAPTION:  Network Diagram
#+LABEL:  fig-network-diagram
#+NAME: fig-network-diagram

[[./diagrams/ansible.png][Network diagram of Ansible]]

* Implementation

The implementation of this system is in terms of a collection of Ansible scripts that
configure the machine.   These scripts need to be organized in a certain way:

#+BEGIN_EXAMPLE

|-- ansible.org
|-- roles
|   |-- ansible
|   |   |-- handlers
|   |   |   `-- main.org
|   |   |-- meta
|   |   |   `-- main.org
|   |   |-- tasks
|   |   |   |-- main.org
|   |   `-- templates
|   |       `-- iptables
|   |-- common
|   |   ... 
#+END_EXAMPLE

We do the implementation in terms of defining suitable scripts for each role.

The top level script resides in =ansible-scripts/ansible.yml=

** Common Roles
Hardening of the machine is done by the common roles.  More information is [[./roles/common/tasks/main.org][here]]

** Specific roles
*** Firewall Rules
Firewall rules are defined [[./roles/ansible/templates/iptables.org][here]]

#+BEGIN_SRC  :tangle ansible-scripts/ansible.yml :eval no
---
- name: Configure ansible server
  hosts: ansible-server
  roles:
    - common
    - ansible
#+END_SRC

                  
** OS updates and patches

** Cron jobs

