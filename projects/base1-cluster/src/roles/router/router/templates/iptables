
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]

-A INPUT -i lo -j ACCEPT
-A OUTPUT -o lo -j ACCEPT
# Allowing INPUT and OUTPUT rules for the ports 80,443 and 53 from anywhere
-A INPUT -p tcp -m multiport --dports 53,80,443 -m state --state NEW,ESTABLISHED -j ACCEPT
-A OUTPUT -p tcp -m multiport --sports 53,80,443 -m state --state ESTABLISHED -j ACCEPT
#-A INPUT -m state --state NEW -p tcp -m tcp --dport 443 -j ACCEPT

#Allow incoming SSH connections.  Hopefully denyhosts will take care of bruteforce attacks
-A INPUT -s {{ansible-server}} -p tcp  --sport 22 -m state --state ESTABLISHED -j ACCEPT

# Allow Ping from Outside to Inside
-A INPUT -p icmp --icmp-type echo-request -j ACCEPT
-A OUTPUT -p icmp --icmp-type echo-reply -j ACCEPT

# Allow Ping from Inside to Outside
-A OUTPUT -p icmp --icmp-type echo-request -j ACCEPT
-A INPUT -p icmp --icmp-type echo-reply -j ACCEPT

# Droping  other ports
-A INPUT -j DROP
-A OUTPUT -j DROP

-A PREROUTING -d {{router-ip}} --dport 80 -p tcp -j DNAT --to-destination {{reverse-proxy-ip}}
-A PREROUTING -d {{router-ip}} --dport 443 -p tcp -j DNAAT --to-destincation {{reverse-proxy-ip}}

-A POSTROUTING -s {{reverse-proxy-ip}} --sport 80 -p tcp -j SNAT --to-source {{router-ip}}
-A POSTROUTING -s {{reverse-proxy-ip}} --sport 443 -p tcp -j SNAT --to-source {{router-ip}}

-A PREROUTING -d {{public-dns-public-ip}} --dport 53 -p udp -j DNAT --to-destination {{public-dns-private-ip}}
-A PREROUTING -d {{public-dns-public-ip}} --dport 53 -p tcp -j DNAT --to-destination {{public-dns-private-ip}}

-A POSTROUTING -s {{public-dns-private-ip}} --sport 53 -p tcp -j SNAT --to-source {{router-ip}}
-A POSTROUTING -s {{public-dns-private-ip}} --sport 53 -p udp -j SNAT --to-source {{router-ip}}

-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

-A INPUT -m state --state NEW -p tcp --dport 22 -s {{ansible-server}} -j ACCEPT

-A INPUT

-A INPUT -p tcp -m multiport --dport 22,80,443,53 -m limit --limit 60/minute --limit-burst 120 -j ACCEPT
-A INPUT -p tcp --dport 22 -m limit --limit 1/minute --limit-burst 2 -j LOG
-A INPUT -p tcp -j DROP
