#+Title: Common Roles
#+Date: 10 March 2015
#+PROPERTY: session *scratch*
#+PROPERTY: results output
#+PROPERTY: exports code
#+SETUPFILE: org-templates/level-0.org


* Introduction:
This document describes the requirements, design and implementation of
the common roles which is part of the cluster. A role is a specific
set of configurations. Common Roles are the roles which will be
applied on all the deployed servers.

* Requirements

The functional requirements for common roles are:

** Functional Requirements

  1. Below common roles are applied at periodic intervals:
    + Ensure the consistency in IP table rules 
    + Mailing the log summary at the end of the day
    + Securing the system by not allowing password based access
    + Capturing and banning the IP's of the suspected malicious
      attacks
    + Keeping the OS updated 
    + Provision to audit the commonds run on the servers

The security best practices needs to be followed in defining the
roles. All processes suggested for =hardening a server= should be
implemented. A good documentation can be found here: [[http://www.serverhardening.com/][Server Hardening]].

* Design:    
Common Roles Diagram
#+CAPTION:  Common Roles Diagram
#+LABEL:  fig-common-diagram
#+NAME: fig-common-diagram

[[./diagrams/common-roles.png]]

Common roles will ensure that all the common roles will be applied on
all the deployed servers, including the ansible.

The diagram can be edited [[https://docs.google.com/a/vlabs.ac.in/drawings/d/1NHBwOSxikqlg5cXbgnKMfnUS_K_iMGkCClktXMOBTw8/edit][HERE]] 

* Implementation:
 The requirements will be accomplished the following way:
    + *Ensure the consistency in IP table rules* - Restarting the IP
      tables
    + *Mailing the log summary at the end of the day* - Installing and
      configuring the logwatch
    + *Securing the system by not allowing password based access* -
      Disabling password-based ssh
    + *Capturing and banning the IP's of the suspected malicious
      attacks* - Installing and configuring fail2ban for ssh)
    + *Keeping the OS updated* - Updating / patching the OS
    + *Provision to audit the commonds run on the servers* - Logging /
      Modfying the history behavior

** Structure of the scripts
The implementation of this system is in terms of a collection of
Ansible scripts that configure the machine.  These scripts are
organized in following way:

#+BEGIN_EXAMPLE
|-- ansible.yml
|-- roles
|   |-- ansible
|   |   |...
|   |   |...
|   |-- common
|   |   |-- files
|   |   |    |-- jail.local
|   |   |    `-- history.sh
|   |   |-- handlers
|   |   |    `-- main.yml
|   |   |-- meta
|   |   |   `-- main.yml
|   |   |-- tasks
|   |   |   |-- aliases.yml
|   |   |   |-- history_config.yml
|   |   |   |-- common_pkg.yml
|   |   |   |-- restart_iptables.yml
|   |   |   |-- logwatch.yml
|   |   |   |-- sendmail_configure.yml
|   |   |   |-- main.yml
|   |   |   |-- fail2ban.yml
|   |   |   `-- sshd_config.yml
|   |   |-- templates
|   |   `-- vars
#+END_EXAMPLE

*** Configuring the Fail2ban local file
The Fail2ban local configuration file called =jail.local= has all the
common rules which will be applied through Fail2ban.
#+BEGIN_SRC shell :tangle roles/common/files/jail.local

#+END_SRC 


*** History
History parameters will be exported for the following:
 - HISTTIMEFORMAT :: display the time stamp along with the command
                     history
 - HISTSIZE       :: is the number of lines or commands that are stored in
                     memory in a history list while bash session is
                     ongoing
 - HISTFILESIZE   :: is the number of lines or commands that are allowed
                     in the history file at startup time of a session,
                     and are stored in the history file at the end of
                     bash session for use in future sessions.

#+BEGIN_SRC shell :tangle roles/common/files/history.sh
#!/bin/bash
HISTTIMEFORMAT  = "%y %m %d %T"
HISTSIZE        = 100000
HISTFILESIZE    = 100000
export HISTTIMEFORMAT HISTSIZE HISTFILESIZE
#+END_SRC 

*** Main file for Handlers
The main file in handlers restarts all the services to update the
changes made to the services. 

*Note:* The aliases services is commented as no functionality is
applicable currently.
#+BEGIN_SRC yaml :tangle roles/common/handlers/main.yml
---
#  - name: rebuild aliases
#    shell: newaliases

  - name: restart iptables
    service: name=iptables state=restarted

  - name: restart sshd
    service: name=sshd state=restarted
  
  - name: restart sendmail
    service: name=sendmail state=restarted

  - name: restart fail2ban
    service: name=fail2ban state=restarted
#+END_SRC

*** Main file for meta
Main file includes the common vaiables defined in =common_vars=.
#+BEGIN_SRC yaml :tangle roles/common/meta/main.yml
---
dependencies:
  - role: common_vars
#+END_SRC


*** Aliases
This files configures the aliases. 
#+BEGIN_SRC yaml :tangle roles/common/tasks/aliases.yml
---
- name: Configure aliases file
  lineinfile: 'dest=/etc/aliases regexp=^root: line="root: alerts@vlabs.ac.in"'
  notify:
    - rebuild aliases
#+END_SRC


*** History Logs
This file calls the =history.sh= and configures the history log for
the commands run everyday.
#+BEGIN_SRC yaml :tangle roles/common/tasks/history_config.yml
---
#This play copies a stock history file
 - name: copying history
   copy: src=history.sh dest=/etc/profile.d/history.sh owner=root group=root mode=0655
#+END_SRC 

*** Common Packages
This file installs the common packages (bind utils) required by admins
to troubleshoot the issues
#+BEGIN_SRC yaml :tangle roles/common/tasks/common_pkg.yml
---
#this play installs the common packages needed by admins to troubleshoot issues
 - name: install bind-utils
   yum: name=bind-utils state=present
   environment:
    proxy_env
#+END_SRC 

*** Restarting the IP tables
This file copies the firewall rules and ensures that they are the
recent updated rules.
#+BEGIN_SRC yaml :tangle roles/common/tasks/restart_iptables.yml
---
- name: restart iptables
  service: name=iptables state=restarted 
#+END_SRC 

*** Configuring the logwatch
This file installs the logwatch  and copies the configuration

#+BEGIN_SRC yaml :tangle roles/common/tasks/logwatch.yml
---
#install and copy logwatch configuration

 - name: install logwatch
   yum: name=logwatch state=present
   environment: proxy_env

# - name: copy logwatch.conf
#   copy: src=logwatch.conf dest=/etc/logwatch/conf/logwatch.conf owner=root group=root mode=0644

 - name: copy logwatch.conf from default directory /etc/
   command: /bin/cp -p /usr/share/logwatch/default.conf/logwatch.conf /etc/logwatch/conf/logwatch.conf

 - name: changing the mail to in logwatch.conf, ensure proper owner,group, mode
   lineinfile: dest=/etc/logwatch/conf/logwatch.conf state=present regexp='^MailTo =' line='MailTo = alerts@vlabs.ac.in' owner=root group=root mode=0644

 - name: change the level of detail to medium
   lineinfile: dest=/etc/logwatch/conf/logwatch.conf state=present regexp='^Detail =' line='Detail = Med'

#+END_SRC


*** Configuring the Mail Records
#+BEGIN_SRC yaml :tangle roles/common/tasks/sendmail_configure.yml
---
#This play configures smart hosts

 - name: Change the smart host entry in /etc/mail/sendmail.mc
   lineinfile: dest=/etc/mail/sendmail.mc regexp="SMART_HOST" line="define(`SMART_HOST', `{{iiit_mail_server}}')dnl"  state=present mode=0644
   notify: 
     - restart sendmail
#+END_SRC


*** Main file under tasks
#+BEGIN_SRC yaml :tangle roles/common/tasks/main.yml
---
 - name: restart iptables
   include: restart_iptables.yml

#- name: Include /etc/aliases configuration
#  include: aliases.yml

 - name: sshd_config
   include: sshd_config.yml

 - name: history file
   include: history_config.yml

 - name: logwatch install
   include: logwatch.yml

 - name: sendmail configure
   include: sendmail_configure.yml

 - name: install common packages
   include: common_pkg.yml
#+END_SRC


*** Fail2ban
Fail2ban scans log files and bans IPs that show the malicious signs of
agents seeking for exploits. It comes with filters for various
services like ssh, apache, mysql etc. Fail2Ban can be used to update
firewall rules to reject the IP addresses for a specified amount of
time. Even other services like sending mails, alerts can be
configured.

*Python* is the pre-requisite package to be installed to run Fail2ban
service. More details can be found in the [[http://www.fail2ban.org/wiki/index.php/Main_Page][WIKI]] page of Fail2ban. 

The objective is to install Fail2ban on all the servers and apply the
local rules.
#+BEGIN_SRC yaml :tangle roles/common/tasks/fail2ban.yml
---
tasks:
   - name: install fail2ban package
     apt: pkg=fail2ban state=present
     when: ansible_distribution=='Debian' or ansible_distribution=='Ubuntu'
     sudo: yes
   
   - name: copy fail2ban local config
     file: src=jail.local dest=/etc/fail2ban/jail.local owner=root group=root  mode=0644
     sudo: yes 
#+END_SRC

The configuration file =jail.local= applies the required rules on all
the servers.


*** Calling the SSHD Configuration
This file copies the modified sshd configuration and restarts using
the handler.

#+BEGIN_SRC yaml :tangle roles/common/tasks/sshd_config.yml

#Modify  sshd_config and call ssh restart handler

# - name: copy sshd_config
#   copy: src=sshd_config dest=/etc/ssh/sshd_config owner=root group=root mode=0644

 - name: Permit root login without-pasword(key based)
   lineinfile: dest=/etc/ssh/sshd_config regexp='PermitRootLogin ' line='PermitRootLogin without-password' state=present

 - name: Disable Password authentication
   lineinfile: dest=/etc/ssh/sshd_config regexp='PasswordAuthentication ' line='PasswordAuthentication no'

 - name: Enable Public key authentication
   lineinfile: dest=/etc/ssh/sshd_config regexp='PubkeyAuthentication ' line='PubkeyAuthentication yes'

 - name: Do not permit empty password, also ensure proper owner, group and permissions
   lineinfile: dest=/etc/ssh/sshd_config regexp='PermitEmptyPasswords ' line='PermitEmptyPasswords no' mode=0600 owner=root group=root

#Call handler to restart sshd
   notify:
     - restart sshd

#+END_SRC
       
