#+Title: Common Roles
#+Author:Zubair S and Prakash B H
#+Date: 10 March 2015
#+PROPERTY: session *scratch*
#+PROPERTY: results output
#+PROPERTY: exports code
#+SETUPFILE: org-templates/level-0.org


* Introduction:
This document describes the requirements, design and implementation of
the common roles which is part of the cluster. A role is a specific
set of configurations. Common Roles are the roles which will be
applied on all the deployed servers.

* Requirements

The functional requirements for common roles are:

** Functional Requirements

  1. Below common roles are applied at periodic intervals:
    + Restarting the IP tables
    + Installing and configuring the logwatch
    + Disabling password-based ssh
    + Installing and configuring fail2ban for ssh
    + Updating / patching the OS
    + Logging / Modfying the history behavior

The security best practices needs to be followed in defining the
roles. All processes suggested for =hardening a server= should be
implemented. A good documentation can be found here: [[http://www.serverhardening.com/][Server Hardening]].

* Design:    
Common Roles Diagram
#+CAPTION:  Common Roles Diagram
#+LABEL:  fig-common-diagram
#+NAME: fig-common-diagram

[[./diagrams/common-roles.png]]

Common roles will ensure that all the common roles will be applied on
all the deployed servers, including the ansible.

The diagram can be edited [[https://docs.google.com/a/vlabs.ac.in/drawings/d/1NHBwOSxikqlg5cXbgnKMfnUS_K_iMGkCClktXMOBTw8/edit][HERE]] 

* Implementation:
** Structure of the scripts
The implementation of this system is in terms of a collection of
Ansible scripts that configure the machine.  These scripts need to be
organized in a certain way:

#+BEGIN_EXAMPLE
|-- ansible.yml
|-- roles
|   |-- ansible
|   |   |...
|   |   |...
|   |-- common
|   |   |-- files
|   |   |    |-- logwatch.conf
|   |   |    |-- jail.local
|   |   |    |-- history.sh
|   |   |    `-- sshd_config
|   |   |-- handlers
|   |   |    `-- main.yml
|   |   |-- meta
|   |   |   `-- main.yml
|   |   |-- tasks
|   |   |   |-- aliases.yml
|   |   |   |-- history-config.yml
|   |   |   |-- restart-iptables.yml
|   |   |   |-- logwatch.yml
|   |   |   |-- main.yml
|   |   |   |-- fail2ban.yml
|   |   |   |-- sshd-config.yml
|   |   |   `-- update-os.yml
|   |   |-- templates
|   |   `-- vars
#+END_EXAMPLE

*** History
History parameters will be exported for the following:
 - HISTTIMEFORMAT :: display the time stamp along with the command
                     history
 - HISTSIZE       :: is the number of lines or commands that are stored in
                     memory in a history list while bash session is
                     ongoing
 - HISTFILESIZE   :: is the number of lines or commands that are allowed
                     in the history file at startup time of a session,
                     and are stored in the history file at the end of
                     bash session for use in future sessions.

#+BEGIN_SRC SHELL :tangle ../build/roles/common/files/history.sh
#!/bin/bash
HISTTIMEFORMAT  = "%y %m %d %T"
HISTSIZE        = 100000
HISTFILESIZE    = 100000
export HISTTIMEFORMAT HISTSIZE HISTFILESIZE
#+END_SRC 

*** SSHD config file
This file sets up the sshd configurations
#+BEGIN_SRC SHELL :tangle ../build/roles/common/files/sshd_config
#	$OpenBSD: sshd_config,v 1.80 2008/07/02 02:24:18 djm Exp $

# This is the sshd server system-wide configuration file.  See
# sshd_config(5) for more information.

# This sshd was compiled with PATH=/usr/local/bin:/bin:/usr/bin

# The strategy used for options in the default sshd_config shipped with
# OpenSSH is to specify options with their default value where
# possible, but leave them commented.  Uncommented options change a
# default value.

#Port 22
#AddressFamily any
#ListenAddress 0.0.0.0
#ListenAddress ::

# Disable legacy (protocol version 1) support in the server for new
# installations. In future the default will change to require explicit
# activation of protocol 1
Protocol 2

# HostKey for protocol version 1
#HostKey /etc/ssh/ssh_host_key
# HostKeys for protocol version 2
#HostKey /etc/ssh/ssh_host_rsa_key
#HostKey /etc/ssh/ssh_host_dsa_key

# Lifetime and size of ephemeral version 1 server key
#KeyRegenerationInterval 1h
#ServerKeyBits 1024

# Logging
# obsoletes QuietMode and FascistLogging
#SyslogFacility AUTH
SyslogFacility AUTHPRIV
#LogLevel INFO

# Authentication:

#LoginGraceTime 2m
#PermitRootLogin yes
PermitRootLogin without-password
#StrictModes yes
#MaxAuthTries 6
#MaxSessions 10

#RSAAuthentication yes
PubkeyAuthentication yes
#AuthorizedKeysFile	.ssh/authorized_keys
#AuthorizedKeysCommand none
#AuthorizedKeysCommandRunAs nobody

# For this to work you will also need host keys in /etc/ssh/ssh_known_hosts
#RhostsRSAAuthentication no
# similar for protocol version 2
#HostbasedAuthentication no
# Change to yes if you don't trust ~/.ssh/known_hosts for
# RhostsRSAAuthentication and HostbasedAuthentication
#IgnoreUserKnownHosts no
# Don't read the user's ~/.rhosts and ~/.shosts files
#IgnoreRhosts yes

# To disable tunneled clear text passwords, change to no here!
#PasswordAuthentication yes
#PermitEmptyPasswords no
PasswordAuthentication no

# Change to no to disable s/key passwords
#ChallengeResponseAuthentication yes
ChallengeResponseAuthentication no

# Kerberos options
#KerberosAuthentication no
#KerberosOrLocalPasswd yes
#KerberosTicketCleanup yes
#KerberosGetAFSToken no
#KerberosUseKuserok yes

# GSSAPI options
#GSSAPIAuthentication no
GSSAPIAuthentication yes
#GSSAPICleanupCredentials yes
GSSAPICleanupCredentials yes
#GSSAPIStrictAcceptorCheck yes
#GSSAPIKeyExchange no

# Set this to 'yes' to enable PAM authentication, account processing, 
# and session processing. If this is enabled, PAM authentication will 
# be allowed through the ChallengeResponseAuthentication and
# PasswordAuthentication.  Depending on your PAM configuration,
# PAM authentication via ChallengeResponseAuthentication may bypass
# the setting of "PermitRootLogin without-password".
# If you just want the PAM account and session checks to run without
# PAM authentication, then enable this but set PasswordAuthentication
# and ChallengeResponseAuthentication to 'no'.
#UsePAM no
UsePAM yes

# Accept locale-related environment variables
AcceptEnv LANG LC_CTYPE LC_NUMERIC LC_TIME LC_COLLATE LC_MONETARY LC_MESSAGES
AcceptEnv LC_PAPER LC_NAME LC_ADDRESS LC_TELEPHONE LC_MEASUREMENT
AcceptEnv LC_IDENTIFICATION LC_ALL LANGUAGE
AcceptEnv XMODIFIERS

#AllowAgentForwarding yes
#AllowTcpForwarding yes
#GatewayPorts no
#X11Forwarding no
#X11DisplayOffset 10
#X11UseLocalhost yes
#PrintMotd yes
#PrintLastLog yes
#TCPKeepAlive yes
#UseLogin no
#UsePrivilegeSeparation yes
#PermitUserEnvironment no
#Compression delayed
#ClientAliveInterval 0
#ClientAliveCountMax 3
#ShowPatchLevel no
#UseDNS yes
#PidFile /var/run/sshd.pid
#MaxStartups 10:30:100
#PermitTunnel no
#ChrootDirectory none

# no default banner path
#Banner none

# override default of no subsystems
Subsystem	sftp	/usr/libexec/openssh/sftp-server

# Example of overriding settings on a per-user basis
#Match User anoncvs
#	X11Forwarding no
#	AllowTcpForwarding no
#	ForceCommand cvs server

#+END_SRC 


*** Logwatch config file
This file sets up the logwatch configurations
#+BEGIN_SRC SHELL :tangle ../build/roles/common/files/logwatch.conf

#+END_SRC 


*** Calling the SSHD Configuration
This file copies the modified sshd configuration and restarts using
the handler.

#+BEGIN_SRC YAML :tangle ../build/roles/common/tasks/sshd-config.yml
#Role to copy the modified sshd_config and call ssh restart handler

#+END_SRC


*** Configuring the logwatch
This file installs the logwatch  and copies the configuration

#+BEGIN_SRC YAML :tangle ../build/roles/common/tasks/logwatch.yml
#install and copy logwatch configuration
---
 - name: install logwatch
   yum: name=logwatch state=present
   environment: proxy_env

 - name: copy logwatch.conf
   copy: src=logwatch.conf dest=/etc/logwatch/conf/logwatch.conf owner=root group=root mode=0644
#+END_SRC

*** Fail2ban
Fail2ban scans log files and bans IPs that show the malicious signs of
agents seeking for exploits. It comes with filters for various
services like ssh, apache, mysql etc. Fail2Ban can be used to update
firewall rules to reject the IP addresses for a specified amount of
time. Even other services like sending mails, alerts can be
configured.

*Python* is the pre-requisite package to be installed to run Fail2ban
service. More details can be found in the [[http://www.fail2ban.org/wiki/index.php/Main_Page][WIKI]] page of Fail2ban. 

The objective is to install Fail2ban on all the servers and apply the
local rules.
#+BEGIN_SRC YAML :tangle ../build/roles/common/tasks/fail2ban.yml
---
tasks:
   - name: install fail2ban package
     apt: pkg=fail2ban state=present
     when: ansible_distribution=='Debian' or ansible_distribution=='Ubuntu'
     sudo: yes
   
   - name: copy fail2ban local config
     file: src=jail.local dest=/etc/fail2ban/jail.local owner=root group=root  mode=0644
     sudo: yes 
#+END_SRC

The configuration file =jail.local= applies the required rules on all
the servers.

*** Configuring the Fail2ban local file
The Fail2ban local configuration file called =jail.local= has all the
common rules which will be applied through Fail2ban.
#+BEGIN_SRC SHELL :tangle ../build/roles/common/files/jail.local

#+END_SRC 
